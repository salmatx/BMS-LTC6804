<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BMS Configuration</title>
  <link rel="stylesheet" href="/bms/css/style.css">
</head>
<body>
  <div class="container">
    <h1>BMS Configuration</h1>
    
    <div class="warning">
      <strong>Warning:</strong> After saving, the ESP32 will restart and apply the new configuration. Make sure all values are correct.
    </div>

    <div id="loadingMsg" class="loading">Loading configuration...</div>

    <form id="configForm" style="display:none;" method="POST" action="/bms/config/save">
      
      <!-- WiFi Configuration -->
      <h2>WiFi Settings</h2>
      <div class="form-group">
        <label for="wifi_ssid">SSID:</label>
        <input type="text" id="wifi_ssid" name="wifi_ssid" maxlength="31" required>
      </div>
      <div class="form-group">
        <label for="wifi_pass">Password: <span class="hint">(leave empty to keep current)</span></label>
        <input type="password" id="wifi_pass" name="wifi_pass" maxlength="63" placeholder="••••••••">
      </div>
      
      <h3>Network Configuration <span class="hint">(leave Static IP empty for DHCP)</span></h3>
      <div class="form-group">
        <label for="wifi_static_ip">Static IP: <span class="hint">(optional)</span></label>
        <input type="text" id="wifi_static_ip" name="wifi_static_ip" maxlength="15" placeholder="192.168.1.100">
      </div>
      <div class="grid">
        <div class="form-group">
          <label for="wifi_gateway">Gateway:</label>
          <input type="text" id="wifi_gateway" name="wifi_gateway" maxlength="15" placeholder="192.168.1.1">
        </div>
        <div class="form-group">
          <label for="wifi_netmask">Netmask:</label>
          <input type="text" id="wifi_netmask" name="wifi_netmask" maxlength="15" placeholder="255.255.255.0">
        </div>
      </div>

      <!-- MQTT Configuration -->
      <h2>MQTT Settings</h2>
      <div class="form-group">
        <label for="mqtt_uri">Broker URI:</label>
        <input type="text" id="mqtt_uri" name="mqtt_uri" placeholder="mqtt://192.168.1.100:1883" maxlength="127" required>
      </div>

      <!-- Battery Configuration -->
      <h2>Battery Thresholds</h2>
      <div class="grid">
        <div class="form-group">
          <label for="cell_v_min">Cell Min Voltage (V):</label>
          <input type="number" id="cell_v_min" name="cell_v_min" step="0.01" min="2.5" max="3.5" required>
        </div>
        <div class="form-group">
          <label for="cell_v_max">Cell Max Voltage (V):</label>
          <input type="number" id="cell_v_max" name="cell_v_max" step="0.01" min="3.5" max="4.5" required>
        </div>
      </div>

      <div class="grid">
        <div class="form-group">
          <label for="pack_v_min">Pack Min Voltage (V):</label>
          <input type="number" id="pack_v_min" name="pack_v_min" step="0.1" min="0" max="100" required>
        </div>
        <div class="form-group">
          <label for="pack_v_max">Pack Max Voltage (V):</label>
          <input type="number" id="pack_v_max" name="pack_v_max" step="0.1" min="0" max="100" required>
        </div>
      </div>

      <div class="grid">
        <div class="form-group">
          <label for="current_min">Min Current (A):</label>
          <input type="number" id="current_min" name="current_min" step="0.1" min="-200" max="0" required>
        </div>
        <div class="form-group">
          <label for="current_max">Max Current (A):</label>
          <input type="number" id="current_max" name="current_max" step="0.1" min="0" max="200" required>
        </div>
      </div>

      <!-- Buttons -->
      <div class="btn-group">
        <button type="button" class="btn-cancel" onclick="cancelConfig()">Cancel</button>
        <button type="submit" class="btn-save">Save & Restart</button>
      </div>
    </form>
  </div>

  <script>
    function fmt2(x) {
      if (x === undefined || x === null || x === '') return '';
      return Number(x).toFixed(2);
    }

    // Load current configuration
    window.addEventListener('DOMContentLoaded', function() {
      fetch('/bms/config/data')
        .then(response => response.json())
        .then(data => {
          document.getElementById('wifi_ssid').value = data.wifi.ssid || '';
          document.getElementById('wifi_pass').placeholder = '(unchanged)';
          document.getElementById('wifi_static_ip').value = data.wifi.static_ip || '';
          document.getElementById('wifi_gateway').value = data.wifi.gateway || '';
          document.getElementById('wifi_netmask').value = data.wifi.netmask || '';
          document.getElementById('mqtt_uri').value = data.mqtt.uri || '';
          document.getElementById('cell_v_min').value = fmt2(data.battery.cell_v_min) || '2.80';
          document.getElementById('cell_v_max').value = fmt2(data.battery.cell_v_max) || '4.20';
          document.getElementById('pack_v_min').value = fmt2(data.battery.pack_v_min) || '39.00';
          document.getElementById('pack_v_max').value = fmt2(data.battery.pack_v_max) || '58.80';
          document.getElementById('current_min').value = fmt2(data.battery.current_min) || '-30.00';
          document.getElementById('current_max').value = fmt2(data.battery.current_max) || '60.00';
          
          document.getElementById('loadingMsg').style.display = 'none';
          document.getElementById('configForm').style.display = 'block';
        })
        .catch(err => {
          document.getElementById('loadingMsg').innerHTML = '<strong>Error loading configuration!</strong>';
          console.error('Error:', err);
        });
    });

    // Form submission with confirmation
    document.getElementById('configForm').addEventListener('submit', function(e) {
      if (!confirm('Save configuration and restart ESP32?')) {
        e.preventDefault();
      }
    });

    // Cancel configuration - clear flag and restart
    function cancelConfig() {
      if (confirm('Exit configuration mode without saving changes?')) {
        // Create and submit a hidden form to POST to cancel endpoint
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/bms/config/cancel';
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
</body>
</html>
